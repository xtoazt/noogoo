FROM debian:bookworm-slim

# Install required packages
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-venv \
    git \
    curl \
    wget \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Set up a non-root user
RUN useradd -m -s /bin/bash user && \
    echo 'user:password' | chpasswd

# Install Python dependencies
# Use --break-system-packages flag for Debian bookworm (PEP 668)
# Create a virtual environment and install packages there
RUN python3 -m venv /opt/venv && \
    /opt/venv/bin/pip install --no-cache-dir --upgrade pip && \
    /opt/venv/bin/pip install --no-cache-dir \
    requests \
    beautifulsoup4 \
    fake-useragent && \
    ln -s /opt/venv/bin/pip3 /usr/local/bin/pip3-venv && \
    ln -s /opt/venv/bin/python3 /usr/local/bin/python3-venv

# Add venv to PATH for user
ENV PATH="/opt/venv/bin:$PATH"

# Clone Auto-Gmail-Creator
WORKDIR /home/user/
RUN git clone --depth 1 https://github.com/ai-to-ai/Auto-Gmail-Creator.git || \
    (mkdir -p Auto-Gmail-Creator && echo "Repository cloned manually")

# Create a wrapper script for account generation with better error handling
RUN printf '#!/bin/bash\n\
cd /home/user/Auto-Gmail-Creator || exit 1\n\
\n\
# Try to find and run the main script\n\
if [ -f "main.py" ]; then\n\
    python3 main.py "$@"\n\
elif [ -f "gmail_creator.py" ]; then\n\
    python3 gmail_creator.py "$@"\n\
elif [ -f "create_account.py" ]; then\n\
    python3 create_account.py "$@"\n\
else\n\
    echo "{\\"error\\": \\"Could not find main script\\", \\"status\\": \\"failed\\"}" >&2\n\
    exit 1\n\
fi\n' > /home/user/generate_account.sh && \
    chmod +x /home/user/generate_account.sh && \
    chown user:user /home/user/generate_account.sh

# Set up environment
ENV HOME="/home/user" \
    TERM="xterm" \
    USER="user" \
    SHELL="/bin/bash" \
    EDITOR="vim" \
    LANG="en_US.UTF-8" \
    LC_ALL="C" \
    PYTHONUNBUFFERED=1

WORKDIR /home/user/

# Default command
CMD [ "/bin/bash" ]
