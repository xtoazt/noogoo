name: Deploy WebVM Gmail Generator

on:
  workflow_dispatch:
    inputs:
      dockerfile_path:
        description: 'Path to Dockerfile'
        required: false
        default: 'dockerfiles/gmail_generator'
  push:
    branches:
      - main

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci || npm install

      - name: Build WebVM disk image
        id: build_disk
        run: |
          echo "Building WebVM disk image from Dockerfile..."
          # Check if WebVM build action is available
          # For now, we'll use a default URL - replace with actual build process
          # You can integrate with WebVM's build system here
          
          # Option 1: Use default WebVM disk (for testing)
          DEFAULT_DISK="wss://disks.webvm.io/debian_large_20230522_5044875331.ext2"
          
          # Option 2: If you have a custom built disk, set it here
          # CUSTOM_DISK="wss://your-cdn.com/your-disk-image.ext2"
          
          # For now, use default - update this when you have a custom disk image
          DISK_URL="${CUSTOM_DISK:-$DEFAULT_DISK}"
          
          echo "disk_url=$DISK_URL" >> $GITHUB_OUTPUT
          echo "Using disk image: $DISK_URL"
          echo "Note: To use a custom disk image, set CUSTOM_DISK environment variable or update this workflow"

      - name: Update config with disk image URL
        run: |
          DISK_URL="${{ steps.build_disk.outputs.disk_url }}"
          echo "Setting disk URL: $DISK_URL"
          
          # Create or update config.js in public folder
          mkdir -p public
          cat > public/config.js << 'EOF'
          // WebVM Configuration - Auto-generated by GitHub Actions
          export const webvmConfig = {
            diskImageUrl: "${{ steps.build_disk.outputs.disk_url }}",
            diskImageType: "cloud",
            memorySize: 512 * 1024 * 1024,
            vgaMemory: 16 * 1024 * 1024,
            networkEnabled: false
          };
          EOF
          
          # Replace placeholder with actual URL
          sed -i "s|\\${{ steps.build_disk.outputs.disk_url }}|$DISK_URL|g" public/config.js
          
          echo "Configuration updated successfully"

      - name: Build project
        run: npm run build

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build
          cname: false
